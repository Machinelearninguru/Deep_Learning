<!DOCTYPE HTML>
<!--
	Arcana by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
<link href="../../../../syntaxhighlighter_3.0.83/styles/shCore.css"
	rel="stylesheet" type="text/css" />
<link href="../../../../syntaxhighlighter_3.0.83/styles/shThemeDefault.css"
	rel="stylesheet" type="text/css" />
<link href="../../../../assets/css/shell.css" rel="stylesheet"
	type="text/css" />

<head>
<link rel="icon" type="image/png" href="../../../../_images/logo1.png">
<title>How to write into and read from a TFRecords file in TensorFlow</title>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet"
	href="../../../../assets/Resources/elighterjs/Resources/bootstrap/bootstrap.min.css">
<link rel="stylesheet" href="../../../../assets/css/main.css" />
<link rel="stylesheet" href="../../../../assets/css/figure_style.css" />
<link rel="stylesheet" href="../../../../assets/css/text_style.css" />
<!-- Favicon !-->
<link rel="stylesheet" type="text/css"
	href="../../../../assets/Resources/elighterjs/Build/EnlighterJS.min.css" />
<style>
    .EnlighterJS {
        width: auto !important;
        overflow-x: scroll !important;
        word-wrap: normal !important;
    }
    
    .EnlighterJS li {
        white-space: pre !important;
    }
</style>
<script type="text/javascript"
	src="../../../../assets/Resources/elighterjs/Resources/MooTools.min.js"></script>
<script type="text/javascript"
	src="../../../../assets/Resources/elighterjs/Build/EnlighterJS.min.js"></script>
<script type="text/javascript" async
	src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
<script type="text/x-mathjax-config"> MathJax.Hub.Config({ tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]} }); </script>
<script type="text/javascript">
        window.addEvent('domready', function () {
            EnlighterJS.Util.Helper(document.getElements('#pycode pre'), {
                indent: 4
                , language: 'python'
                , renderer: 'Block'
                , grouping: true
                , theme: 'Beyond'
                , showLinenumbers: true
            });
     
            EnlighterJS.Util.Helper(document.getElements('#pycode code.ih'), {
                renderer: 'Inline'
                , language: 'python'
                , theme: 'Beyond'
            });
        });
    </script>
</head>

<body>
	<div id="page-wrapper">
		<!-- Header -->
		<div id="header">

			<!-- Nav -->
			<nav id="nav">
				<ul>
					<li><a href="../../../../index.php">Home</a></li>
					<li><a href="#">></a></li>
					<li><a href="../../../../topics.php?my_id=4">Deep Learning</a></li>
					<li><a href="#">></a></li>
					<li><a href="../../../../posts.php?my_id=10">TensorFlow</a></li>
				</ul>
			</nav>

		</div>

		<!-- Main -->
		<section class="wrapper style1">
			<div class="container">
				<div class="row 200%">
					<div class="4u 12u(narrower)">
						<div id="sidebar">
							<!-- Sidebar -->
							<section>
								<h3>
									<img src="../../../../_images/logo2.png"
										style="width: 64px; height: 64px; vertical-align: middle;"
										alt="" />&emsp;<a id="logo" style="vertical-align: middle;"
										href="../../../../index.php">Machine Learning Guru</a>
								</h3>
								<p>Machine Learning and Computer Vision tutorials using open
									source packages.</p>
							</section>
							<section>
								<h3>Sections</h3>
								<ul class="links">
									<li><a href="#intro">Introduction</a></li>
									<li><a href="#list">List images and their labels</a></li>
									<li><a href="#create">Create a TFRecords file</a></li>
									<li><a href="#read">Read the TFRecords file</a></li>
								</ul>
							</section>
						</div>
					</div>
					<div class="8u  12u(narrower) important(narrower)">
						<div id="content">
							<!--    #######################             -->
							<!--    #######################             -->
							<!--    Content: Your post starts here      -->
							<!--    #######################             -->
							<!--    #######################             -->
							<article id="post_top">
								<header align="center">
									<h2>How to write into and read from a TFRecords file in TensorFlow</h2>
									<p>In this post, you will learn how to save a large amount
										of data (images) into a single TFRecords format file and load it
										batch-wise to train your network in tensorflow.</p>
								</header>
								<!--    #######################  ####################### ####################### #######################            -->
								<!--    #######################  ####################### ####################### #######################            -->
								<!--    #######################  ####################### ####################### #######################            -->
								<!--    #######################  ####################### ####################### #######################            -->
								<h2 id="intro">Introduction</h2>
								<p align="justify"> 
									In the <a href="../hdf5/hdf5.html">previous post</a> we explained the benefits of saving a large dataset in a single HDF5 file. In this post we will learn how to
									convert our data into the Tensorflow standard format, called TFRecords. When we are training a deep network, we have two options to feed the data into out Tensorflow
									program: loading the data using pure python code at each step and feed it into a computaion graph or use an input pipeline which takes a list of filenames 
									(any supported format), shuffle them (optional), create a file queue, read, and decode the data. However, TFRecords is the recommended file format for Tensorflow.</p>
								<p align="justify">
									In this post, we load, resize and save all the images inside the train folder of the well-known <a href='https://www.kaggle.com/c/dogs-vs-cats'>Dogs vs. Cats</a> 
									data set into a single TFRecords file and then load and plot a couple of them as samples. To follow the rest of this post you need to download the train part of the Dogs vs. Cats data set.
								</p>
								<h2 id="list">List images and their labels</h2>
									<p align="justify">First, we need to list all images and label them. We give each cat image a label = 0 and each dog image a label = 1. The following code list all images, 
										give them proper labels, and then shuffle the data. We also divide the data set into three train (%60), validation (%20), and test parts (%20).</p>
									<div class="panel panel-default">
										<div class="panel-heading">List images and label them</div>
										<div class="panel-body" id="pycode">
<pre data-enlighter-title="python Code">
from random import shuffle
import glob
shuffle_data = True  # shuffle the addresses before saving
cat_dog_train_path = 'Cat vs Dog/train/*.jpg'

# read addresses and labels from the 'train' folder
addrs = glob.glob(cat_dog_train_path)
labels = [0 if 'cat' in addr else 1 for addr in addrs]  # 0 = Cat, 1 = Dog

# to shuffle data
if shuffle_data:
    c = list(zip(addrs, labels))
    shuffle(c)
    addrs, labels = zip(*c)
    
# Divide the hata into 60% train, 20% validation, and 20% test
train_addrs = addrs[0:int(0.6*len(addrs))]
train_labels = labels[0:int(0.6*len(labels))]

val_addrs = addrs[int(0.6*len(addrs)):int(0.8*len(addrs))]
val_labels = labels[int(0.6*len(addrs)):int(0.8*len(addrs))]

test_addrs = addrs[int(0.8*len(addrs)):]
test_labels = labels[int(0.8*len(labels)):]
</pre>
										</div>
									</div>									
								<h2 id="create">Create a TFRecords file</h2>
								<p align="justify">
									First we need to load the image and convert it to the data type (float32 in this example) in which we want to save the data into a TFRecords file. 
									Let's write a function which take an image address, load, resize, and return the image in proper data type:
								</p>
<div class="panel panel-default">
                                    <div class="panel-heading">A function to Load images</div>
                                    <div class="panel-body" id="pycode">
<pre data-enlighter-title="Load image">
def load_image(addr):
    # read an image and resize to (224, 224)
    # cv2 load images as BGR, convert it to RGB
    img = cv2.imread(addr)
    img = cv2.resize(img, (224, 224), interpolation=cv2.INTER_CUBIC)
    img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
    img = img.astype(np.float32)
    return img
</pre>
</div>	</div>							
								<p align="justify">
									Before we can store the data into a TFRecords file, we should stuff it in a protocol buffer called <b>Example</b>. Then, we serialize the protocol buffer to a string and 
									write it to a TFRecords file. Example protocol buffer contains <b>Features</b>. Feature is a protocol to describe the data and could have three types: bytes, float, and int64.
									In summary, to store your data you need to follow these steps:
								</p>
								<div class="panel-body" id="pycode">
								<ul style="list-style-type: square;" align="justify">
									<li> Open a TFRecords file using <code class="ih" >tf.python_io.TFRecordWriter</code>
									</li>
									<li> Convert your data into the proper data type of the feature using <code class="ih" >tf.train.Int64List</code>, <code class="ih" >tf.train.BytesList</code>, or
									<code class="ih" >tf.train.FloatList</code>
									</li>									
									<li> Create a feature using <code class="ih" >tf.train.Feature</code> and pass the converted data to it
									</li>
									<li> Create an Example protocol buffer using <code class="ih" >tf.train.Example</code> and pass the feature to it
									</li>
									<li> Serialize the Example to string using <code class="ih" >example.SerializeToString()</code>
									</li>
									<li> Write the serialized example to TFRecords file using <code class="ih" >writer.write</code>
									</li>									
								</ul>
								<p align="justify"> We are going to use the following two functions to create features (Functions are from this <a href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/examples/how_tos/reading_data/convert_to_records.py">Tensorflow Tutorial</a>)</p>	
								</div>
															<div class="panel panel-default">
                                    <div class="panel-heading">Convert data to features</div>
                                    <div class="panel-body" id="pycode">
<pre data-enlighter-title="tables">
def _int64_feature(value):
  return tf.train.Feature(int64_list=tf.train.Int64List(value=[value]))


def _bytes_feature(value):
  return tf.train.Feature(bytes_list=tf.train.BytesList(value=[value]))
</pre> 
</div>	</div>	
<p align="justify">Now let's store the training data to the TFRecords file.</p>
<div class="panel panel-default">
                                    <div class="panel-heading">Write data into a TFRecords file</div>
                                    <div class="panel-body" id="pycode">
<pre data-enlighter-title="tables">
train_filename = 'train.tfrecords'  # address to save the TFRecords file

# open the TFRecords file
writer = tf.python_io.TFRecordWriter(train_filename)

for i in range(len(train_addrs)):
    # print how many images are saved every 1000 images
    if not i % 1000:
        print 'Train data: {}/{}'.format(i, len(train_addrs))
        sys.stdout.flush()

    # Load the image
    img = load_image(train_addrs[i])

    label = train_labels[i]

    # Create a feature
    feature = {'train/label': _int64_feature(label),
               'train/image': _bytes_feature(tf.compat.as_bytes(img.tostring()))}

    # Create an example protocol buffer
    example = tf.train.Example(features=tf.train.Features(feature=feature))
    
    # Serialize to string and write on the file
    writer.write(example.SerializeToString())
    
writer.close()
sys.stdout.flush()
</pre>
</div>	</div>	
 <div class="panel-body" id="pycode"><p align="justify">and finaly  we close the file using: <code class="ih" >writer.close()</code>. Similarly we write the validation and test data to two other TFRecords files.</p></div>
 <div class="panel panel-default">
                                    <div class="panel-heading">Write validation and test data into a TFRecords file</div>
                                    <div class="panel-body" id="pycode">
<pre data-enlighter-title="tables">
# open the TFRecords file
val_filename = 'val.tfrecords'  # address to save the TFRecords file
writer = tf.python_io.TFRecordWriter(val_filename)

for i in range(len(val_addrs)):
    # print how many images are saved every 1000 images
    if not i % 1000:
        print 'Val data: {}/{}'.format(i, len(val_addrs))
        sys.stdout.flush()

    # Load the image
    img = load_image(val_addrs[i])

    label = val_labels[i]

    # Create a feature
    feature = {'val/label': _int64_feature(label),
               'val/image': _bytes_feature(tf.compat.as_bytes(img.tostring()))}

    # Create an example protocol buffer
    example = tf.train.Example(features=tf.train.Features(feature=feature))

    # Serialize to string and write on the file
    writer.write(example.SerializeToString())

writer.close()
sys.stdout.flush()

# open the TFRecords file
test_filename = 'test.tfrecords'  # address to save the TFRecords file
writer = tf.python_io.TFRecordWriter(test_filename)

for i in range(len(test_addrs)):
    # print how many images are saved every 1000 images
    if not i % 1000:
        print 'Test data: {}/{}'.format(i, len(test_addrs))
        sys.stdout.flush()

    # Load the image
    img = load_image(test_addrs[i])

    label = test_labels[i]

    # Create a feature
    feature = {'test/label': _int64_feature(label),
               'test/image': _bytes_feature(tf.compat.as_bytes(img.tostring()))}

    # Create an example protocol buffer
    example = tf.train.Example(features=tf.train.Features(feature=feature))

    # Serialize to string and write on the file
    writer.write(example.SerializeToString())

writer.close()
sys.stdout.flush()
</pre>
</div>	</div>	

 							<h2 id="read">Read the TFRecords file</h2>
								<div class="panel-body" id="pycode"><p align="justify">
									It's time to learn how to read data from the TFRecords file. To do so, we load the data from the train data in batchs of an arbitrary size and plot images of the 5 batchs. We also
									check the label of each image. To read from files in tensorflow, you need to do the following steps: 
								<ul style="list-style-type: square;" align="justify">
								<li><b>Create a list of filenames:</b> In our case we only have a single file <code class="ih" >data_path = 'train.tfrecords'</code>. Therefore, our list is gonna be like this: <code class="ih" >[data_path]</code></li>
								<li><b>Create a queue to hold filenames:</b> To do so, we use <code class="ih" >tf.train.string_input_producer</code> tf.train.string_input_producer function which hold filenames in a FIFO queue. it gets the list of filnames. It also has some optional arguments
								including  <code class="ih" >num_epochs</code> which indicates the number of epoch you want to to load the data and <code class="ih" >shuffle</code> which indicates whether to suffle the filenames in the list or not. It is 
								set to <b>True</b> by default.</li>
								<li><b>Define a reader:</b> For files of TFRecords we need to define a TFRecordReader with <code class="ih" >reader = tf.TFRecordReader()</code>. Now, the reader returns the next record using: <code class="ih" >reader.read(filename_queue)</code></li>
								<li><b>Define a decoder:</b> A decoder is needed to decode the record read by the reader. In case of using TFRecords files the decoder should be <code class="ih" >tf.parse_single_example</code>. it takes a serialized Example and a dictionary which maps feature keys to  FixedLenFeature or VarLenFeature values and returns a dictionary which maps feature keys to Tensor values: <code class="ih" >features = tf.parse_single_example(serialized_example, features=feature)</code></li>
								<li><b>Convert the data from string back to the numbers:</b> <code class="ih" >tf.decode_raw(bytes, out_type)</code> takes a Tensor of type string and convert it to type<code class="ih" >out_type</code>. However, for labels which have not been converted to string, we just need to cast them using <code class="ih" >tf.cast(x, dtype)</code></li>
								<li><b>Reshape data into its original shape:</b> You should reshape the data (image) into it's original shape before serialization using <code class="ih" >image = tf.reshape(image, [224, 224, 3])</code></li>
								<li><b>Preprocessing:</b> if you want to do any preprocessing you should do it now.</li>
								<li><b>Batching:</b> Another queue is needed to create batches from the examples. You can create the batch queue using <code class="ih" >tf.train.shuffle_batch([image, label], batch_size=10, capacity=30, num_threads=1, min_after_dequeue=10)</code> where <code class="ih" >capacity</code> is the maximum size of queue, <code class="ih" >min_after_dequeue</code> is the minimum size of queue after dequeue, and <code class="ih" >num_threads</code> is the number of threads enqueuing examples. Using more than one thread, it comes up with a faster reading. The first argument in a list of tensors which you want to create batches from.</li>
								</ul>
								</p></div>
<div class="panel panel-default">
                                    <div class="panel-heading">Read a TFRecords file</div>
                                    <div class="panel-body" id="pycode">
<pre>
import tensorflow as tf
import numpy as np
import matplotlib.pyplot as plt

data_path = 'train.tfrecords'  # address to save the hdf5 file

with tf.Session() as sess:
    feature = {'train/image': tf.FixedLenFeature([], tf.string),
               'train/label': tf.FixedLenFeature([], tf.int64)}

    # Create a list of filenames and pass it to a queue
    filename_queue = tf.train.string_input_producer([data_path], num_epochs=1)

    # Define a reader and read the next record
    reader = tf.TFRecordReader()
    _, serialized_example = reader.read(filename_queue)

    # Decode the record read by the reader
    features = tf.parse_single_example(serialized_example, features=feature)

    # Convert the image data from string back to the numbers
    image = tf.decode_raw(features['train/image'], tf.float32)
    
    # Cast label data into int32
    label = tf.cast(features['train/label'], tf.int32)

    # Reshape image data into the original shape
    image = tf.reshape(image, [224, 224, 3])
    
    # Any preprocessing here ...
    
    # Creates batches by randomly shuffling tensors
    images, labels = tf.train.shuffle_batch([image, label], batch_size=10, capacity=30, num_threads=1, min_after_dequeue=10)
</pre> 
</div>	</div>
<div class="panel-body" id="pycode"><p align="justify">
								<ul style="list-style-type: square;" align="justify">
								<li><b>Initialize all global and local variables</b></li>
								<li><b>Filing the example queue:</b> Some functions of <code class="ih" >tf.train</code> such as <code class="ih" >tf.train.shuffle_batch</code> add <code class="ih" >tf.train.QueueRunner</code> objects to your graph. Each of these objects hold a list of enqueue op for a queue to run in a thread. Therefore, to fill a queue you need to call <code class="ih" >tf.train.start_queue_runners</code> which starts threades for all the queue runners in the graph.
								 However, to manage these threads you need a <code class="ih" >tf.train.Coordinator</code> to terminate the threads at the proper time.</li>
								 </ul>
								 Everything is ready. Now you can read a batch and plot all batch images and labels. Do not forget to stop the threads (by stopping the cordinator) when you are done with your reading process. 
								</p></div>
<div class="panel panel-default">
                                    <div class="panel-heading">Read a TFRecords file</div>
                                    <div class="panel-body" id="pycode">
<pre  data-enlighter-lineoffset="34" >
    # Initialize all global and local variables
    init_op = tf.group(tf.global_variables_initializer(), tf.local_variables_initializer())
    sess.run(init_op)

    # Create a coordinator and run all QueueRunner objects
    coord = tf.train.Coordinator()
    threads = tf.train.start_queue_runners(coord=coord)

    for batch_index in range(5):
        img, lbl = sess.run([images, labels])

        img = img.astype(np.uint8)

        for j in range(6):
            plt.subplot(2, 3, j+1)
            plt.imshow(img[j, ...])
            plt.title('cat' if lbl[j]==0 else 'dog')

        plt.show()

    # Stop the threads
    coord.request_stop()
    
    # Wait for threads to stop
    coord.join(threads)
    sess.close()
</pre> 
</div>	</div>									
								<p align="justify">
									You can download the codes of this post in our <a href="TFRecords.html">Github</a> page.
								</p>

							</article>
							<br>
							<a href="#post_top">Go Top</a><br>
							<br>
							<!--    #######################  ####################### ####################### #######################            -->
							<!--    #######################  ####################### ####################### #######################            -->
							<!--    #######################  ####################### ####################### #######################            -->
							<!--    #######################  ####################### ####################### #######################            -->
							<!--    #######################             -->
							<!--             Comments                   -->
							<div id="disqus_thread"></div>
							<script>
                                (function () { // DON'T EDIT BELOW THIS LINE
                                    var d = document
                                        , s = d.createElement('script');
                                    s.src = '//machine-learning-guru.disqus.com/embed.js';
                                    s.setAttribute('data-timestamp', +new Date());
                                    (d.head || d.body).appendChild(s);
                                })();
                            </script>
							<noscript>
								Please enable JavaScript to view the <a
									href="https://disqus.com/?ref_noscript">comments powered by
									Disqus.</a>
							</noscript>
						</div>
					</div>
				</div>
			</div>
		</section>
		<!-- Footer -->
		<div id="footer">
			<div class="container">
				<div class="row">
					<section class="3u 6u(narrower) 12u$(mobilep)">
						<h3>Related Posts:</h3>
						<!-- <ul class="links">
                            <li><a href="#">Mattis et quis rutrum</a></li>
                            <li><a href="#">Suspendisse amet varius</a></li>
                            <li><a href="#">Sed et dapibus quis</a></li>
                        </ul>
                    </section>
                    <section class="3u 6u$(narrower) 12u$(mobilep)">
                        <h3>More Links to Stuff</h3>
                        <ul class="links">
                            <li><a href="#">Duis neque nisi dapibus</a></li>
                            <li><a href="#">Sed et dapibus quis</a></li>
                            <li><a href="#">Rutrum accumsan sed</a></li>
                        </ul>
                    </section>-->
				</div>
			</div>
			<!-- Icons -->
			<ul class="icons">
				<li><a href="https://twitter.com/M_L_Guru"
					class="icon fa-twitter"><span class="label">Twitter</span></a></li>
				<li><a href="https://github.com/Machinelearninguru"
					class="icon fa-github"><span class="label">GitHub</span></a></li>
				<li><a href="https://www.linkedin.com/groups/12030461"
					class="icon fa-linkedin"><span class="label">LinkedIn</span></a></li>
			</ul>
			<!-- Copyright -->
			<div class="copyright">
				<ul class="menu">
					<li>&copy; Machine Learning Guru. All rights reserved</li>
					<li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
				</ul>
			</div>
		</div>
	</div>
	<!-- Scripts -->
	<script src="../../../../assets/js/jquery.min.js"></script>
	<script src="../../../../assets/js/jquery.dropotron.min.js"></script>
	<script src="../../../../assets/js/skel.min.js"></script>
	<script src="../../../../assets/js/util.js"></script>
	<script src="../../../../assets/js/main.js"></script>
	<script id="dsq-count-scr"
		src="//machine-learning-guru.disqus.com/count.js" async></script>
</body>

</html>
